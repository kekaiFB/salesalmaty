{% load static %} 

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/underscore@1.12.0/underscore-min.js"></script> 
<script src = "{% static 'js/chartjs-plugin-sorting.js' %}"></script>

<script>
    $(".single-item").slick({
        dots: false,
        infinite: false,
        speed: 500,
        slidesToShow: 2,
        slidesToScroll: 1, 
        rows: 2,
        
    }); 


    var myChart1;
    var label1, value1, datasets1=[]; 
    const ctx1 = document.getElementById('oneChart').getContext('2d');

    var myChart2;
    var label2, value2, value2Day, value2Office; 
    const ctx2 = document.getElementById('twoChart').getContext('2d');

    var myChart3;
    var label3, value3; 
    const ctx3 = document.getElementById('threeChart').getContext('2d');


    var myChart4;
    var label4, value4, datasets4=[]; 
    const ctx4 = document.getElementById('fourChart').getContext('2d');
    /* 
        var myChart5;
        var label5, value5, datasets5=[]; 
        const ctx5 = document.getElementById('fiveChart').getContext('2d');
    */
    var status_load = 0

    
    const sortChartData = (chart, sortFunc) => {
      
    resetChartData(chart);
    
    var dataIndexVis = []
    for (var i=0; i<chart.data.datasets.length; i++)
    {
      if (chart.getDatasetMeta(i).visible)
      {
        dataIndexVis.push(i)
      }
    }

    var chartData = []

    for (var i=0; i<dataIndexVis.length; i++)
    {
      for (var j=0; j<chart.data.datasets[0].data.length; j++)
      {   
        if(i==0){
           chartData[j] = chart.data.datasets[dataIndexVis[i]].data[j]
        } else {
          chartData[j] += chart.data.datasets[dataIndexVis[i]].data[j]
        }
       
      }
    }

    var chartLabels = chart.data.labels;

    var chartDataArray = chartData.map((dataPoint, index) => ({
      data: dataPoint,
      label: chartLabels[index],
    }));


    chartDataArray.sort(sortFunc);


    const sortedChartData = chartDataArray.map(dataObj => dataObj.data);
    const sortedChartLabels = chartDataArray.map(dataObj => dataObj.label);


    
    var originalLabels = chart.data.labels;
    var count_datasets = chart.data.datasets.length;
  
    var datasets = []
    //–î–∞—Ç–∞—Å–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–≤–Ω—ã –ø–æ —Ä–∞–∑–º–µ—Ä—É!!!!

    //–ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–∞–º–æ—É –∏–∑ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
    for (var i=0; i<count_datasets; i++)
    {
      var datasets = []
      //–ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –æ–±—ä–µ–∫—Ç–∞–º –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
      for (var j=0; j<originalLabels.length; j++)
      {
        // —Å—É—Ç—å —Ç–∞–∫–∞—è, –±–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞, –∏ –∏—â–µ–º –∏–Ω–¥–µ–∫—Å —Ç–∞–∫–æ–≥–æ –∂–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º
        var index = originalLabels.indexOf(sortedChartLabels[j])

        // –∑–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ç–∞—Å–µ—Ç–∞, –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ, —Ç–æ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ –∂–µ, –∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–æ–≤ —Ä–∞–∑–Ω–∞—è
        datasets.push(chart.data.datasets[i].data[index])
      }
      chart.data.datasets[i].data = datasets
    }
      
     
   
    chart.data.labels = sortedChartLabels;

    chart.update();
    chart.resize();
  }

  const resetChartData = (chart) => {

    for (var i=0; i<chart.data.datasets.length; i++)
    {
      const originalChartData = chart.originalData[i].datasets[0].data;
      const originalChartLabels = chart.originalData[i].labels;

      // Update the chart with the original data, labels, and colors
      chart.data.datasets[i].data = originalChartData;
      chart.data.labels = originalChartLabels;
    }
    
    chart.update();
    chart.resize();
  };

    function drawTable (table) {

        //–ü–ï–†–í–´–ô –ì–†–ê–§–ò–ö
        label1 = chartData(table).map( function( value ) {
            return value['label']
        });
        datasets1 = reasonGraphicHuman(table); 

        //–ü–Ø–¢–´–ô –ì–†–ê–§–ò–ö
        /* 
        label5 = chartDataNotReason(table).map( function( value ) {
                return value['label']
            });
            value5 = chartDataNotReason(table).map( function( value ) {
                return value['value']
            });
            */
        
        //–í–¢–û–†–û–ô –ì–†–ê–§–ò–ö
        label2 = chartDataOffice(table).map( function( value ) {
            return value['label']
        });

        value2 = chartDataOffice(table).map( function( value ) {
            return value['value']
        })   

        value2Day = chartDataOfficeDay(table).map( function( value ) {
            return value['value']
        })   

        value2Office = getEmployeeOffice(table).map( function( value ) {
            return value['value']
        }) 


        //–¢–†–ï–¢–ò–ô –ì–†–ê–§–ò–ö
        label3 = chartDataDate(table).map( function( value ) {
            return value['label']
        });
        label3 = getMonthOfDayArray(label3)
        value3 = chartDataDate(table).map( function( value ) {
            return value['value']
        }) 
        
        // –®–∞–≥ 1: –ù–∞–π—Ç–∏ –Ω–∞—á–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ–≥–æ –Ω—É–ª–µ–≤–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Å –Ω–∞—á–∞–ª–∞ –º–∞—Å—Å–∏–≤–∞
        var startIndex = 0;
        while (startIndex < value3.length && value3[startIndex] === 0) {
            startIndex++;
        }

        // –®–∞–≥ 2: –ù–∞–π—Ç–∏ –∫–æ–Ω–µ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ–≥–æ –Ω—É–ª–µ–≤–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Å –∫–æ–Ω—Ü–∞ –º–∞—Å—Å–∏–≤–∞
        var endIndex = value3.length - 1;
        while (endIndex >= 0 && value3[endIndex] === 0) {
            endIndex--;
        }

        // –®–∞–≥ 3: –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –º–æ–Ω–æ—Ç–æ–Ω–Ω—ã–µ –Ω—É–ª–µ–≤—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ –∫—Ä–∞—è–º
        if (startIndex > 0) {
            value3.splice(0, startIndex);
            label3.splice(0, startIndex);
        }

        if (endIndex < value3.length - 1) {
            value3.splice(endIndex + 1);
            label3.splice(endIndex + 1);
        }

        employeValue3 =  chartDataDateEmployee(table)
        
        

        //–ß–ï–¢–í–ï–†–¢–´–ô –ì–†–ê–§–ò–ö
        label4 = chartDataMonth(table).map( function( value ) {
            return value['label']
        });

        datasets4 = reasonGraphicMonth(table);

        /*
            let startIndices = [];
            let endIndices = [];

            datasets4.forEach(dataset => {
                let [startIndex, endIndex] = findNonZeroRange(dataset.data);
                if (startIndex !== -1) { 
                    startIndices.push(startIndex);
                    endIndices.push(endIndex);
                }
            });
            */
        /*let commonStartIndex = Math.max(...startIndices);
        let commonEndIndex = Math.min(...endIndices);

        // –û–±—Ä–µ–∑–∞–µ–º –º–∞—Å—Å–∏–≤—ã –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ç–æ–∫
        datasets4.forEach(dataset => {
            dataset.data = dataset.data.slice(commonStartIndex, commonEndIndex + 1);
        });
        label4 = label4.slice(commonStartIndex, commonEndIndex + 1);
        console.log(label4)*/


        if (myChart1) {
            updateCharts();
        }
    }

    function init() {
        //–ü–ï–†–í–´–ô –ì–†–ê–§–ò–ö
        myChart1 = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels : label1,
                datasets: datasets1
            },
            options: {
               plugins: {
                    title: {
                        display: true,
                        text: '–ü—Ä–æ–¥–∞–∂–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º',
                        font: {
                            size: 20
                          },
                    },
                },
                
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: true,
                    },
                    x: {
                        stacked: true,
                    }
                }
            }
        })
        var backgroundColor_office = []

        for (let i = 0; i < label2.length; i++) {
            backgroundColor_office.push(getRGBA());
        }

        //–í–¢–û–†–û–ô –ì–†–ê–§–ò–ö
        myChart2 = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels : label2,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤',
                    data : value2,
                    backgroundColor: backgroundColor_office,
                    borderColor: backgroundColor_office,
                    borderWidth: 1
                }]
            },
            options: {                
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            labelColor: function(context) {
                                return {
                                    borderWidth: 2,
                                    borderDash: [2, 2],
                                    borderRadius: 2,
                                    caretSize: 1,
                                };
                            },
                            label: function(context) {
                                return label2[context.dataIndex]
                            },
                            afterLabel: function(context) {
                                var data = []
                                var text =  '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ' + value2[context.dataIndex]
                                data.push(text)
                                var text =  '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π ' + value2Day[context.dataIndex]
                                data.push(text)
                                data.push([])
                                data.push('–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:')
                                
                                var list = Object.keys(value2Office[context.dataIndex])
                                var list_values = Object.values(value2Office[context.dataIndex])
                                for (var m =0; m<list.length; m++) {
                                    var elem = list[m] + ' ' + list_values[m]
                                    data.push(elem)
                                }
                         
                                return data
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: '–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º',
                        font: {
                            size: 20
                          }
                    }
                },
                responsive: true,
                maintainAspectRatio: false,
              
            }
        })


    
        //–¢–†–ï–¢–ò–ô –ì–†–ê–§–ò–ö
        //–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –¥–Ω—è–º
        myChart3 = new Chart(ctx3, {
            type: 'bar',
            data: {
                datasets: [{
                    label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ  –ø—Ä–æ–ø—É—Å–∫–æ–≤",
                    data : value3,
                    backgroundColor: 'rgba(75, 192, 50, 0.7)',
                    borderColor: 'rgba(75, 192, 50, 0.7)',
                    borderWidth: 1
                }]
            },
            options: {              
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            labelColor: function(context) {
                                return {
                                    backgroundColor: 'rgba(212, 237, 191, 0.2)',
                                    borderWidth: 2,
                                    borderDash: [2, 2],
                                    borderRadius: 2,
                                    caretSize: 1,
                                };
                            },
                            /* beforeLabel: function(context) {
                                return employeValue3[context.dataIndex][0][0]
                            }, */
                            label: function(context) {
                                count_employe = '–ü—Ä–æ–¥–∞–∂–∏ ' + context.formattedValue
                                return count_employe
                            },
                            afterLabel: function(context) {
                                var text = '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ' +employeValue3[context.dataIndex].length + ':'
                                var employe = [' ']
                                employe.push(text)
                                for (var m =0; m<employeValue3[context.dataIndex].length; m++) {
                                    var employe_text = employeValue3[context.dataIndex][m][1] + ' ' + employeValue3[context.dataIndex][m][2]
                                    employe.push(employe_text)
                                }
                                return employe 
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: '–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –¥–Ω—è–º',
                        font: {
                            size: 20
                          }
                    }
                },
                scales: {
                    //–î–Ω–∏ –Ω–∞ –≥—Ä–∞—Ñ–∫–∏–µ
                    x: { 
                        labels : cleanConsecutiveDuplicates(label3.map(elem => elem.split(';')[0])),
                        display: false, // –≠—Ç–æ —Å–∫—Ä–æ–µ—Ç –æ—Å—å x, –Ω–æ –º–µ—Ç–∫–∏ –æ—Å—Ç–∞–Ω

                    },
                    //–ú–µ—Å—è—Ü—ã –Ω–∞ –≥—Ä–∞—Ñ–∫–∏–µ
                    x2: {  
                        labels : cleanConsecutiveDuplicates(label3.map(elem => elem.split(';')[1])),
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            reverse: false,
                            stepSize: 1
                          },
                    },
                    
                },
            }
        })
     

        
        //–ß–ï–¢–í–ï–†–¢–´–ô –ì–†–ê–§–ò–ö
        myChart4 = new Chart(ctx4, {
            type: 'bar',
            data: {
                labels : label4,
                datasets: datasets4,
            },
            options: {              
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ—Å—è—Ü–∞–º',
                        font: {
                            size: 20
                        },
                       
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: true,
                    },
                    x: {
                        stacked: true,
                    }
                }
            }
        })
        sortUserGraph()
    }
    
    function updateCharts() {
          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ myChart1
        if (myChart1) {
            myChart1.data.labels = label1;
            myChart1.data.datasets = datasets1;
            myChart1.update();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ myChart2
        if (myChart2) {
            myChart2.data.labels = label2;
            myChart2.data.datasets[0].data = value2;
            // –ï—Å–ª–∏ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –≤ myChart2, —Ç–æ –∏—Ö —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å
            // –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å datasets[1], —Ç–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –µ–≥–æ –∑–¥–µ—Å—å
            myChart2.update();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ myChart3
        if (myChart3) {
            // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∫–∞ labels_X –∏ labels_X2
            var labels_X = cleanConsecutiveDuplicates(label3.map(elem => elem.split(';')[0]));
            var labels_X2 = cleanConsecutiveDuplicates(label3.map(elem => elem.split(';')[1]));

            myChart3.options.scales.x.labels = labels_X;
            myChart3.options.scales.x2.labels = labels_X2;
            myChart3.data.datasets[0].data = value3;

            // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –¥—Ä—É–≥–∏–µ –¥–∞—Ç–∞—Å–µ—Ç—ã myChart3 –∑–¥–µ—Å—å, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            myChart3.update();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ myChart4
        if (myChart4) {
            myChart4.data.labels = label4;
            myChart4.data.datasets = datasets4;
            myChart4.update();
        }

        // –ï—Å–ª–∏ myChart5 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –µ–≥–æ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
        // if (myChart5) {
        //     myChart5.data.labels = label5;
        //     myChart5.data.datasets[0].data = value5;
        //     myChart5.update();
        // }
        if (myChart4) {
            sortUserGraph()
        }
    
    }

    function cleanConsecutiveDuplicates(arr) {
        let result = [];
        for (let i = 0; i < arr.length; i++) {
            if (i === 0 || arr[i] !== arr[i - 1]) {
                result.push(arr[i]);
            }
        }
        return result;
    }
    
    function findNonZeroRange(data) {
        console.log(data)
        let startIndex = data.findIndex(value => value !== 0);
        let endIndex = data.length - 1 - [...data].reverse().findIndex(value => value !== 0);

        // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω—É–ª–µ–≤–æ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º -1
        if (startIndex === -1) return [-1, -1];

        return [startIndex, endIndex];
    }
    
    
    
    function sortUserGraph() {
        $('.chart_1_sort').html(`
            <div>
            <span class="sort_chart1_asc h1">‚ÜóÔ∏è</span>
            <span class="sort_chart1_desc h1">‚ÜòÔ∏è</span>
            </div>
        `);

        // Save a copy of the original data for resetting later
        myChart1.originalData = []
      
        for (var i=0; i<myChart1.data.datasets.length; i++)
        {
            myChart1.originalData[i] = {
            datasets: [{ data: [...myChart1.data.datasets[i].data], borderColor: [...myChart1.data.datasets[i].borderColor], backgroundColor: [...myChart1.data.datasets[i].backgroundColor] }],
            labels: [...myChart1.data.labels]
            };
        }
        sortChartData(myChart1, (a, b) => b.data - a.data);

        $('span').on('click', function () {
            if (this.className.includes('sort_chart1_asc')) {
                sortChartData(myChart1, (a, b) => a.data - b.data);

            } else if (this.className.includes('sort_chart1_desc')) {
                sortChartData(myChart1, (a, b) => b.data - a.data);

            } else if (this.className.includes('reset_chart1')) {
                resetChartData(myChart1);
            }
        });


        $('.chart_4_sort').html(`
            <div>
                <span class="h1 sort_chart4_asc">‚ÜóÔ∏è</span>
                <span class="h1 sort_chart4_desc">‚ÜòÔ∏è</span>
                <span class="h1 reset_chart4">üîÑ</span>
            </div>
        `);

        // Save a copy of the original data for resetting later
        myChart4.originalData = []
    
        for (var i=0; i<myChart4.data.datasets.length; i++)
        {
            myChart4.originalData[i] = {
            datasets: [{ data: [...myChart4.data.datasets[i].data], borderColor: [...myChart4.data.datasets[i].borderColor], backgroundColor: [...myChart4.data.datasets[i].backgroundColor] }],
            labels: [...myChart4.data.labels]
            };
        }

        $('span').on('click', function () {
            if (this.className.includes('sort_chart4_asc')) {
                sortChartData(myChart4, (a, b) => a.data - b.data);

            } else if (this.className.includes('sort_chart4_desc')) {
                sortChartData(myChart4, (a, b) => b.data - a.data);

            } else if (this.className.includes('reset_chart4')) {
                resetChartData(myChart4);
            }
        });


    }

</script>